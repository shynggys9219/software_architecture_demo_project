version: "3.9"

services:
  mongo1:
    image: mongo:7.0
    container_name: mongo1
    command: ["mongod","--replSet","rs0","--bind_ip_all","--port","27017"]
    ports: ["27017:27017"]
    volumes: ["mongo1:/data/db"]
    restart: unless-stopped
    networks: [appnet]
    healthcheck:
      test: ["CMD-SHELL","mongosh --quiet --port 27017 --eval 'db.adminCommand(\"ping\").ok' | grep 1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 40

  mongo2:
    image: mongo:7.0
    container_name: mongo2
    command: ["mongod","--replSet","rs0","--bind_ip_all","--port","27018"]
    ports: ["27018:27018"]
    volumes: ["mongo2:/data/db"]
    restart: unless-stopped
    networks: [appnet]
    healthcheck:
      test: ["CMD-SHELL","mongosh --quiet --port 27018 --eval 'db.adminCommand(\"ping\").ok' | grep 1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 40

  mongo3:
    image: mongo:7.0
    container_name: mongo3
    command: ["mongod","--replSet","rs0","--bind_ip_all","--port","27019"]
    ports: ["27019:27019"]
    volumes: ["mongo3:/data/db"]
    restart: unless-stopped
    networks: [appnet]
    healthcheck:
      test: ["CMD-SHELL","mongosh --quiet --port 27019 --eval 'db.adminCommand(\"ping\").ok' | grep 1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 40

  mongo-setup:
    image: mongo:7.0
    container_name: mongo-setup
    depends_on:
      mongo1: { condition: service_healthy }
      mongo2: { condition: service_healthy }
      mongo3: { condition: service_healthy }
    networks: [appnet]
    restart: "no"
    entrypoint:
      - bash
      - -lc
      - >
        mongosh --quiet --host mongo1:27017 --eval '
          rs.initiate({
            _id: "rs0",
            members: [
              { _id: 0, host: "mongo1:27017" },
              { _id: 1, host: "mongo2:27018" },
              { _id: 2, host: "mongo3:27019" }
            ]
          });
          // wait for PRIMARY
          for (let i=0;i<120;i++) {
            try {
              const s = rs.status();
              if (s.ok===1 && s.members && s.members.some(m=>m.stateStr==="PRIMARY")) break;
            } catch (e) {}
            sleep(1000);
          }
          printjson(rs.status().members.map(m=>({name:m.name,state:m.stateStr})));
        '

  # --- App instances (FastAPI) ---
  app1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: app1
    env_file: .env
    depends_on:
      mongo-setup: { condition: service_started }
    networks: [appnet]

  app2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: app2
    env_file: .env
    depends_on:
      mongo-setup: { condition: service_started }
    networks: [appnet]

  # --- NGINX (expects ./nginx/Dockerfile & ./nginx/nginx.conf) ---
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx-lb
    depends_on: [app1, app2]
    ports: ["8080:80"]
    networks: [appnet]

volumes:
  mongo1: {}
  mongo2: {}
  mongo3: {}

networks:
  appnet: {}
